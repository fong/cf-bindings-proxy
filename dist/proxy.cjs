"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const f=require("./transform.cjs"),m=async o=>({...o,__calls:await Promise.all(o.__calls.map(async a=>({...a,args:await Promise.all(a.args.map(c=>f.prepareDataForProxy(c.data,c)))})))}),b=async o=>{const a=await m(o),c=JSON.stringify(a);let n;try{n=await fetch("http://127.0.0.1:8799",{body:c,method:"POST",cache:"no-store",headers:{"Content-Type":"application/json"}})}catch{throw new Error("Unable to connect to binding proxy")}const{success:s,data:e,transform:i,functions:t}=await n.json();if(!s)throw new Error(e||"Bad response from binding proxy");const r=i?f.transformData(e,i):e;if(t&&r&&typeof r=="object"&&!Array.isArray(r))for(const[u,_]of Object.entries(t)){const l=await f.transformFunctionInfo(_,t);if(_.asAccessor){const d=typeof l=="function"&&!(l instanceof Blob)?await l():l;if(u==="body"){const h=new ReadableStream({start(g){g.enqueue(d),g.close()}});Object.defineProperties(r,{body:{get(){return h}},bodyUsed:{get(){return h.locked}}})}else Object.defineProperty(r,u,{get(){return d}})}else r[u]=l}return r},w=(o,a,c,n)=>new Proxy(n,{get(s,e){if(!n||["then",Symbol.iterator,Symbol.toStringTag].includes(e))return;if(e in n||["error","results"].includes(e))return n[e];if(Array.isArray(n)&&typeof e=="string"&&!Number.isNaN(Number(e)))return n[Number(e)];if(["toJSON"].includes(e))return n;if(e==="writeHttpMetadata"&&n&&typeof n=="object"){const t=n.httpMetadata||{};return r=>{t.cacheControl&&r.set("cache-control",t.cacheControl),t.cacheExpiry&&r.set("expires",t.cacheExpiry.toUTCString()),t.contentDisposition&&r.set("content-disposition",t.contentDisposition),t.contentEncoding&&r.set("content-encoding",t.contentEncoding),t.contentLanguage&&r.set("content-language",t.contentLanguage),t.contentType&&r.set("content-type",t.contentType)}}const i=y(a,{notChainable:!0,proxyType:o});return i.__original_call=c,async(...t)=>(i.__calls.push({prop:e,args:t.map(r=>({data:r}))}),b(i))}}),P=o=>["prepare"].includes(o)?["first","run","all","raw"]:[],U=(o,a)=>({__proxyType:o,__bindingId:a,__calls:[],__chainUntil:[]}),y=(o,{notChainable:a=!1,proxyType:c="binding"}={})=>new Proxy(U(c,o),{get(n,s){if(typeof s=="string"&&s.startsWith("__"))return n[s];if(s!=="toJSON"&&!a&&!(n.__calls.length===0&&s==="then")){if(n.__chainUntil.length||(n.__chainUntil=P(s)),n.__chainUntil.length&&!n.__chainUntil.includes(s)){const e=y(o,{proxyType:c});return e.__chainUntil=n.__chainUntil,e.__calls=n.__calls,(...i)=>(n.__calls.push({prop:s,args:i.map(t=>({data:t}))}),e)}return async(...e)=>{n.__calls.push({prop:s,args:e.map(t=>({data:t}))});const i=await b(n);return typeof i!="object"||!i||Array.isArray(i)||[URL,Request,Response].find(t=>i instanceof t)?i:w(c,o,n,i)}}}});exports.createBindingProxy=y;
//# sourceMappingURL=proxy.cjs.map

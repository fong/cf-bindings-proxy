{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import type { Cache, CacheStorage } from '@cloudflare/workers-types';\r\nimport { createBindingProxy } from './proxy';\r\n\r\n/**\r\n * Whether the bindings proxy is enabled and currently active.\r\n *\r\n * The proxy is enabled by default in development mode, but can be disabled by setting\r\n * `DISABLE_BINDINGS_PROXY` to `true`.\r\n *\r\n * Alternatively, it can be enabled in other environments by setting `ENABLE_BINDINGS_PROXY` to\r\n * `true`.\r\n * */\r\nexport const isProxyEnabled = () =>\r\n\ttypeof process !== 'undefined' &&\r\n\t(process?.env?.ENABLE_BINDINGS_PROXY ||\r\n\t\t(!process?.env?.DISABLE_BINDINGS_PROXY && process?.env?.NODE_ENV === 'development'));\r\n\r\n/**\r\n * Interfaces with a binding from the environment.\r\n *\r\n * @example\r\n * ```ts\r\n * const value = await binding<KVNamespace>('MY_KV').get('key');\r\n * ```\r\n *\r\n * @example\r\n * By default, `process.env` is used in production, however, a custom fallback can be provided.\r\n * ```ts\r\n * const MY_KV = binding<KVNamespace>('MY_KV', { fallback: platform.env });\r\n * ```\r\n *\r\n * @param id Binding ID.\r\n * @param opts Binding options, such as a custom fallback.\r\n * @returns Binding value.\r\n */\r\nexport const binding = <T>(id: string, opts?: BindingOpts): T => {\r\n\tif (isProxyEnabled()) {\r\n\t\treturn new Proxy(\r\n\t\t\t{},\r\n\t\t\t{\r\n\t\t\t\tget: (_, prop) => createBindingProxy<T>(id, { proxyType: 'binding' })[prop as keyof T],\r\n\t\t\t},\r\n\t\t) as T;\r\n\t}\r\n\r\n\treturn (opts?.fallback ?? process?.env)?.[id] as T;\r\n};\r\n\r\ntype DeriveCacheReturnType<T> = T extends 'default' | undefined ? Cache : Promise<Cache>;\r\n\r\n/**\r\n * Interfaces with the Cloudflare Cache API.\r\n *\r\n * By default, the `default` cache is used, however, a custom cache can be provided by passing a\r\n * cache name as the first argument.\r\n *\r\n * @example\r\n * ```ts\r\n * const value = await cacheApi().put(..., ...);\r\n * ```\r\n *\r\n * @example\r\n * ```ts\r\n * const value = await cacheApi('custom').put(..., ...);\r\n * ```\r\n *\r\n * @param cacheName Name of the cache to open, or `undefined` to open the default cache.\r\n * @returns Cache instance.\r\n */\r\nexport const cacheApi = <T extends string | undefined = undefined>(\r\n\tcacheName?: T,\r\n): DeriveCacheReturnType<T> => {\r\n\tif (isProxyEnabled()) {\r\n\t\treturn new Proxy(\r\n\t\t\t{},\r\n\t\t\t{\r\n\t\t\t\tget: (_, prop: keyof Cache) =>\r\n\t\t\t\t\tcreateBindingProxy<Cache>(cacheName ?? 'default', { proxyType: 'caches' })[prop],\r\n\t\t\t},\r\n\t\t) as DeriveCacheReturnType<T>;\r\n\t}\r\n\r\n\tconst cachesInstance = caches as unknown as CacheStorage;\r\n\r\n\treturn (\r\n\t\tcacheName === 'default' || cacheName === undefined\r\n\t\t\t? cachesInstance.default\r\n\t\t\t: cachesInstance.open(cacheName)\r\n\t) as DeriveCacheReturnType<T>;\r\n};\r\n\r\ntype BindingOpts = {\r\n\tfallback: Record<string, unknown>;\r\n};\r\n"],"names":["isProxyEnabled","_a","_b","_c","binding","id","opts","_","prop","createBindingProxy","cacheApi","cacheName","cachesInstance"],"mappings":"0IAYO,MAAMA,EAAiB,IAC7B,WAAA,cAAO,QAAY,QAClBC,EAAA,6BAAS,MAAT,YAAAA,EAAc,wBACb,GAACC,EAAA,6BAAS,MAAT,MAAAA,EAAc,2BAA0BC,EAAA,6BAAS,MAAT,YAAAA,EAAc,YAAa,gBAoB1DC,EAAU,CAAIC,EAAYC,IAA0B,OAChE,OAAIN,IACI,IAAI,MACV,CAAC,EACD,CACC,IAAK,CAACO,EAAGC,IAASC,EAAA,mBAAsBJ,EAAI,CAAE,UAAW,UAAW,EAAEG,CAAe,CACtF,CAAA,GAIMP,GAAAK,GAAA,YAAAA,EAAM,YAAY,6BAAS,OAA3B,YAAAL,EAAkCI,EAC3C,EAuBaK,EACZC,GAC8B,CAC9B,GAAIX,IACH,OAAO,IAAI,MACV,CAAC,EACD,CACC,IAAK,CAACO,EAAGC,IACRC,qBAA0BE,GAAa,UAAW,CAAE,UAAW,QAAU,CAAA,EAAEH,CAAI,CACjF,CAAA,EAIF,MAAMI,EAAiB,OAGtB,OAAAD,IAAc,WAAaA,IAAc,OACtCC,EAAe,QACfA,EAAe,KAAKD,CAAS,CAElC"}